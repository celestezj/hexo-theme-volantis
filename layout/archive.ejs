<%- partial('_pre') %>
<div class='l_main<%- page.sidebar == false ? ' no_sidebar' : '' %>'>
	<% if (page.year || page.month) { %>
		<%- partial('_partial/archive') %>
	<% } else { %>
	  <article id="arc" class="post article white-box reveal <%- theme.custom_css.body.effect.join(' ') %>">
            <%- partial('_widget/post-calendar') %>
			<% var year = -1, postid = -1; %>
			<% site.posts.sort('date', -1).each(function(post) { %>
				<% post.year = date(post.date, 'YYYY'); %>
				<% if (post.archive == undefined || post.archive == true) { %>
					<% if (post.year && post.year !== year) { %>
						<% year = post.year; %>
						<h2><%= year %></h2>
					<% } %>
						<div class='timenode'>
								<a class="meta" href="<%= url_for(post.link || post.path) %>">
									<time><%= date(post.date, 'MM-DD') %></time>
									<% if(post.title){ %>
										<%- post.title %>
									<% } else if (post.date) { %>
										<%= date(post.date, config.date_format) %>
									<% } %>
									<% if(theme.plugins.aplayer && theme.plugins.aplayer.enable && post.music && post.music.enable != false){ %>
										&nbsp;<i class="fas fa-headphones-alt music" aria-hidden="true"></i>
									<% } %>
									<% if (post.icon) { %>
										&nbsp;<i class="<%- post.icon %>" aria-hidden="true"></i>
									<% } %>
									<% (post.icons && post.icons||[]).forEach(function(icon){ %>
										&nbsp;<i class="<%- icon %>" aria-hidden="true"></i>
									<% }) %>
								</a>
						</div>
				<% } %>
			<% }); %>
	  </article>
	<% } %>
</div>
<%- partial('_partial/side') %>

<script type="text/javascript">
    var myChart = echarts.init(document.getElementById('post-calendar'));
	window.addEventListener("resize", () => { myChart.resize(); });

    <%
    // calculate range.
    var startDate = moment().subtract(1, 'years');
    var endDate = moment();
    var rangeArr = '["' + startDate.format('YYYY-MM-DD') + '", "' + endDate.format('YYYY-MM-DD') + '"]';

    // post and count map.
    var dateMap = new Map();
    site.posts.forEach(function (post) {
        var date = post.date.format('YYYY-MM-DD');
        var count = dateMap.get(date);
        dateMap.set(date, count == null || count == undefined ? 1 : count + 1);
    });

    // loop the data for the current year, generating the number of post per day
    var i = 0;
    var datePosts = '[';
    var dayTime = 3600 * 24 * 1000;
    for (var time = startDate; time <= endDate; time += dayTime) {
        var date = moment(time).format('YYYY-MM-DD');
        datePosts = (i === 0 ? datePosts + '["' : datePosts + ', ["') + date + '", ' +
            (dateMap.has(date) ? dateMap.get(date) : 0) + ']';
        i++;
    }
    datePosts += ']'; %>

    var option = {
	    animation: true,
        title: {
            top: 0,
            text: '文章日历',
            left: 'center',
            textStyle: {
                color: '#3C4858'
            }
        },
        tooltip: {
            padding: 10,
            backgroundColor: '#555',
            borderColor: '#777',
            borderWidth: 1,
            formatter: function (obj) {
                var value = obj.value;
                return '<div style="font-size: 14px;">' + value[0] + '：' + value[1] + '</div>';
            }
        },
        visualMap: {
            show: true,
            showLabel: true,
			min: 0,
			max: 10000,
            categories: [0, 1, 2, 3, 4],
            calculable: true,
            inRange: {
                symbol: 'rect',
                color: ['#ebedf0', '#c6e48b', '#7bc96f', '#239a3b', '#196127']
            },
			outOfRange: {
			    color: '#ff0000'
			},
            itemWidth: 12,
            itemHeight: 12,
            orient: 'horizontal',
            left: 'center',
            bottom: 0
        },
        calendar: [{
            left: 'center',
            range: <%- rangeArr %>,
            cellSize: [13, 13],
            splitLine: {
                show: false
            },
            itemStyle: {
                width: '1.88679%',
                height: '15px',
                color: '#EEEEEE',
                borderColor: '#FFF',
                borderWidth: 2
            },
            yearLabel: {
                show: false
            },
            monthLabel: {
                nameMap: 'cn',
                fontWeight: 'lighter',
                fontSize: 12
            },
            dayLabel: {
                show: true,
                formatter: '{start}  1st',
                fontWeight: 'lighter',
                nameMap: ['日',' ',' ','三',' ',' ','六',],
                fontSize: 12
            }
        }],
        series: [{
            type: 'heatmap',
            coordinateSystem: 'calendar',
            calendarIndex: 0,
            data: <%- datePosts %>
        }]

    };
    myChart.setOption(option);
	setTimeout(function(){myChart.resize();},200);
</script>